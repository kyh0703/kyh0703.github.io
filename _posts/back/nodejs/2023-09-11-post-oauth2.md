---
published: true
title: "Github OAuth ì¸ì¦ë°©ë²•"
categories:
  - Nodejs
tags:
  - [nodejs, nest]
toc: true
toc_sticky: true
date: "2023-09-11 09:00"
---

## OAuthë€

ê¸°ì¡´ì— í”Œë«í¼ í™˜ê²½ì— ì¸ì¦ëœ ì •ë³´ë¥¼ ê°€ì§€ê³  ì¸ì¦ê³¼ ê¶Œí•œì„ íšë“í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤

> ê¸°ì¡´ ì‚¬ìš©ìë“¤ì€ ìƒˆë¡œìš´ ì•„ì´ë””ë¥¼ ë“±ë¡í•˜ì—¬ ê°€ì…í•˜ëŠ” ê²ƒì— ë²ˆê±°ë¡œì›€ì„ ëŠë¼ê³  ìˆê¸°ì— ê¸°ì¡´ì— í”Œë«í¼ì— ë“±ë¡ëœ ì •ë³´ë“¤ì„ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸ì„ ì‹œë„í•©ë‹ˆë‹¤.

![Application Code Grant Flow](https://www.kmaschta.me/content/github-oauth-authentication-without-server/authorization_code_grant.png)

1. ë¨¼ì € `frontend`ì—ì„œ í”Œë«í¼ ì¸ì¦ ì„œë²„ë¡œ ì¸ì¦ìš”ì²­ì„ ì‹œë„í•©ë‹ˆë‹¤.
2. í”Œë«í¼ ì¸ì¦ì„œë²„ëŠ” ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
3. `user`ëŠ” í•´ë‹¹ í˜ì´ì§€ì— ê¶Œí•œ ì„¤ì •ì„ í™•ì¸ í•œ í›„ ë¡œê·¸ì¸ì„ í•©ë‹ˆë‹¤.
4. ì¸ì¦ ìš”ì²­ ì „ ë¯¸ë¦¬ ì €ì¥í•œ `redirect_uri`ë¥¼ í†µí•´  í˜ì´ì§€ì— `code`ë¥¼ ì „ë‹¬í•˜ì—¬ ì¤ë‹ˆë‹¤.
5. `frontend`ëŠ” `backend`ë¡œ í•´ë‹¹ `code`ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
6. `backend`ëŠ” `code`ë¥¼ í†µí•´ ì§€ì •ëœ `uri`ë¥¼ í†µí•´ `access_token`ì„ ë°›ì•„ì˜µë‹ˆë‹¤.
7. `backend`ëŠ” ë°œê¸‰ ë°›ì€ `access_token`ì„ ê°€ì§€ê³  `user`ì •ë³´ë¥¼ ë°›ì•„ì˜¬ ìˆ˜ ìˆëŠ” `uri`ì— ìš”ì²­í•©ë‹ˆë‹¤.
8. `backend`ëŠ” `user`ì •ë³´ë¥¼ ì·¨ë“í•©ë‹ˆë‹¤

> `frontend`ì—ì„œ `code`ë¥¼ ë¨¼ì € ì·¨ë“í•˜ì˜€ìœ¼ë‚˜,  `backend`ì—ê²Œ `Get`ìš”ì²­ë§Œ ë³´ë‚¸ í›„ `backend`ì—ì„œ ìœ„ì˜ ì¼ë ¨ì˜ ê³¼ì •ì¼ ì§„í–‰ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. 
>
> ê³¼ì •ì€ ë™ì¼í•©ë‹ˆë‹¤.

## ì˜ˆì‹œ

ì €ëŠ” ì•„ë˜ ì˜ˆì‹œì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

* front: nextjs
* back: nestjs

### Github

1. ë¨¼ì € ë‹¤ìŒê³¼ ê°™ì´ `github`ì— ë¡œê·¸ì¸í•˜ì—¬ ì ‘ì†í•œ í›„ `Developer settings`ì— ì ‘ê·¼í•©ë‹ˆë‹¤.

![image-20230911093127956](../../../assets/images/posts/2023-09-11-post-oauth2/image-20230911093127956.png)

2. ì ‘ê·¼ í›„ `OAuth Apps`ì— ì ‘ê·¼í•˜ì—¬ ë‚´ê°€ ë“±ë¡í•  ì•±ì„ ì§€ì •í•˜ì—¬ ì¤ë‹ˆë‹¤.

> ì—¬ê¸°ì„œ í™ˆí˜ì´ì§€ëŠ” ë¡œì»¬ ê°œë°œí™˜ê²½ì´ê¸°ì— localhostë¥¼ ì§€ì •í•˜ì˜€ìŠµë‹ˆë‹¤. ë˜í•œ callbackURLì— ê²½ìš° ì‚¬ìš©ìê°€ ì¸ì¦í•œ í›„ codeê°€ ë„˜ì–´ì˜¤ëŠ” í˜ì´ì§€ë¥¼ ë§í•©ë‹ˆë‹¤.

![image-20230911093230556](../../../assets/images/posts/2023-09-11-post-oauth2/image-20230911093230556.png)

3. `clientID`ì™€ `client Secret`ì„ ë°›ì•„ì˜µë‹ˆë‹¤.

> í•´ë‹¹ ê°’ë“¤ì€ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥í•˜ì—¬ ì¤ë‹ˆë‹¤.

![image-20230911093420403](../../../assets/images/posts/2023-09-11-post-oauth2/image-20230911093420403.png)

### Front

1. ì¸ì¦ í˜ì´ì§€ë¡œ `code`ë¥¼ ë°›ê¸° ìœ„í•´ ìš”ì²­í•©ë‹ˆë‹¤.

```tsx
export default function SigninPage() {
  const router = useRouter()
  
  // êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
  const handleSigninWithGithub = () => {
    const url = 'https://github.com/login/oauth/authorize'
    const query = qs.stringify({
      client_id: process.env.NEXT_PUBLIC_GITHUB_CLIENT_ID,
      redirect_uri: process.env.NEXT_PUBLIC_GITHUB_REDIRECT_URL,
    })
    router.push(url + '?' + query)
  }
}
```

2. `Redirect URL`í˜ì´ì§€ë¥¼ êµ¬í˜„í•˜ì—¬ ë°›ì€ `code`ê°’ì„ `backend`ì— ìš”ì²­í•©ë‹ˆë‹¤

```tsx
'use client'

import { useSearchParams, useRouter } from 'next/navigation'
import { useEffect } from 'react'
import { styled } from 'styled-components'
import Spinner from '@/components/atoms/Spinner'

const SpinnerWrapper = styled.div`
  text-align: center;
`

export default function GithubOAuthPage() {
  const router = useRouter()
  const searchParams = useSearchParams()

  useEffect(() => {
    const getToken = async () => {
      const code = { code: searchParams.get('code') }
      const url = '/api/proxy/auth/github-oauth'
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(code),
      })
      console.log(response)
      router.push('/')
    }

    getToken()
  }, [])

  return (
    <SpinnerWrapper>
      <Spinner isAutoCentering />
    </SpinnerWrapper>
  )
}
```

### Back

`nodejs`ì˜ ê²½ìš° `passport`ë¥¼ í†µí•´ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ë§Œ, í•´ë‹¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì•„ë˜ëŠ” ì§ì ‘ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

ì»¨íŠ¸ë¡¤ëŸ¬

```js
@Controller('auth')
export class AuthController {
  private readonly logger: Logger = new Logger(AuthController.name)
  constructor(private authService: AuthService) {}

  @HttpCode(HttpStatus.CREATED)
  @Post('/github-oauth')
  githubOAuth(@Body() githubOAuthDto: GithubOAuthDto) {
    this.logger.debug('github: ')
    return this.authService.signinWithGithub(githubOAuthDto)
  }
}
```

ì„œë¹„ìŠ¤

```js
@Injectable()
export class AuthService {
  private readonly logger: Logger = new Logger(AuthService.name)

  async signinWithGithub(
    githubOAuthDto: GithubOAuthDto,
  ): Promise<GithubUserData> {
    const { code } = githubOAuthDto
    const getTokenUrl: string = `https://github.com/login/oauth/access_token`
    const request = {
      code,
      client_id: this.configService.get<string>('oauth.githubId'),
      client_secret: this.configService.get<string>('oauth.githubSecret'),
    }

    const response: AxiosResponse = await axios.post(getTokenUrl, request, {
      headers: {
        accept: 'application/json',
      },
    })
    if (response.data.error) {
      throw new UnauthorizedException('ê¹ƒí—ˆë¸Œ ì¸ì¦ì„ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤')
    }

    const { access_token } = response.data
    const getUserUrl: string = 'https://api.github.com/user'
    const { data } = await axios.get(getUserUrl, {
      headers: {
        Authorization: `token ${access_token}`,
      },
    })

    const { login, avatar_url, name, bio, company } = data

    const githubInfo: GithubUserData = {
      githubId: login,
      avatar: avatar_url,
      name,
      description: bio,
      localtion: company,
    }

    return githubInfo
  }
}
```

## ë§ˆì¹˜ë©°

ì§ì ‘ êµ¬í˜„í•˜ì‹œëŠ” ê²ƒë³´ë‹¤ `passport`ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì‹œëŠ”ê²Œ ë” ì¢‹ìŠµë‹ˆë‹¤ë§Œ, `golang`ì´ë‚˜ ë‹¤ë¥¸ ì–¸ì–´ì— ê²½ìš° ì§ì ‘ êµ¬í˜„ì´ í•„ìš”í•˜ê¸°ì— êµ¬í˜„ ë‚´ìš©ì„ ì •ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.

ë§¤ì»¤ë‹ˆì¦˜ì€ ê±°ì˜ ë‹¤ ë¹„ìŠ·í•˜ê¸°ì— í”Œë«í¼ì—ì„œ ì œê³µí•˜ëŠ” ë¬¸ì„œë¥¼ ì½ì–´ë³´ì‹œë©´ êµ¬í˜„ì— ì–´ë ¤ì›€ì´ ì—†ìœ¼ì‹¤ ê²ë‹ˆë‹¤ğŸ‘
